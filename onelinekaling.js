const cryptoModule=require("./crypto"),CryptoJS=cryptoModule.CryptoJS;exports.Kakao=function(){function e(){this.apiKey=null,this.cookies={},this.loginReferer=null,this.cryptoKey=null,this.parsedTemplate=null,this.csrf=null}return e.prototype.isInitialized=function(){return!!this.apiKey},e.prototype.static={ua:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36",ct:"application/x-www-form-urlencoded",ka:"sdk/1.36.6 os/javascript lang/en-US device/Win32 origin/http%3A%2F%2Fdevelopers.kakao.com"},e.prototype.login=function(e,t,o){if("string"!=typeof o||32!==o.length)throw new TypeError("api key "+o+" is not valid api key");if(this.apiKey=o,!this.isInitialized())throw new ReferenceError("method login is called before initialization");if("string"!=typeof e)throw new TypeError("invalid id type "+typeof e);if("string"!=typeof t)throw new TypeError("invalid password type "+typeof t);return function(){const e=org.jsoup.Jsoup.connect("https://sharer.kakao.com/talk/friends/picker/link");e.header("User-Agent",this.static.ua),e.data({app_key:this.apiKey,validation_action:"default",validation_params:"{}",ka:this.static.ka,lcba:""}),e.ignoreHttpErrors(!0),e.method(org.jsoup.Connection.Method.POST);const t=e.execute();if(401===t.statusCode())throw new ReferenceError("invalid api key");if(200!==t.statusCode())throw new Error("unexpected error on method login");Object.assign(this.cookies,{_kadu:t.cookie("_kadu"),_kadub:t.cookie("_kadub"),_maldive_oauth_webapp_session:t.cookie("_maldive_oauth_webapp_session")});const o=t.parse();this.cryptoKey=o.select("input[name=p]").attr("value"),this.loginReferer=t.url().toString()}.bind(this)(),function(){const e=org.jsoup.Jsoup.connect("https://track.tiara.kakao.com/queen/footsteps");e.ignoreContentType(!0);const t=e.execute();this.cookies.TIARA=t.cookie("TIARA")}.bind(this)(),function(){const o=org.jsoup.Jsoup.connect("https://accounts.kakao.com/weblogin/authenticate.json");o.header("User-Agent",this.static.ua),o.header("Referer",this.loginReferer),o.cookies(this.cookies),o.data({os:"web",webview_v:"2",email:CryptoJS.AES.encrypt(e,this.cryptoKey).toString(),password:CryptoJS.AES.encrypt(t,this.cryptoKey).toString(),continue:decodeURIComponent(this.loginReferer.split("continue=")[1]),third:"false",k:"true"}),o.ignoreContentType(!0),o.method(org.jsoup.Connection.Method.POST);const i=o.execute(),s=JSON.parse(i.body());if(-450===s.status)throw new ReferenceError("invalid id or password");if(0!==s.status)throw new Error("unexpected error on method login");Object.assign(this.cookies,{_kawlt:i.cookie("_kawlt"),_kawltea:i.cookie("_kawltea"),_karmt:i.cookie("_karmt"),_karmtea:i.cookie("_karmtea")})}.bind(this)(),this},e.prototype.send=function(e,t,o){o=o||"default",function(){const e=org.jsoup.Jsoup.connect("https://sharer.kakao.com/talk/friends/picker/link");e.header("User-Agent",this.static.ua),e.header("Referer",this.loginReferer),e.cookies({TIARA:this.cookies.TIARA,_kawlt:this.cookies._kawlt,_kawltea:this.cookies._kawltea,_karmt:this.cookies._karmt,_karmtea:this.cookies._karmtea}),e.data({app_key:this.apiKey,validation_action:o,validation_params:JSON.stringify(t),ka:this.static.ka,lcba:""}),e.method(org.jsoup.Connection.Method.POST),e.ignoreHttpErrors(!0);const i=e.execute();if(400===i.statusCode())throw new TypeError("invalid template parameter");Object.assign(this.cookies,{KSHARER:i.cookie("KSHARER"),using:"true"});const s=i.parse();this.parsedTemplate=JSON.parse(s.select("#validatedTalkLink").attr("value")),this.csrf=s.select("div").last().attr("ng-init").split("'")[1]}.bind(this)(),function(){const e=org.jsoup.Jsoup.connect("https://sharer.kakao.com/api/talk/chats");e.header("User-Agent",this.static.ua),e.header("Referer","https://sharer.kakao.com/talk/friends/picker/link"),e.header("Csrf-Token",this.csrf),e.header("App-Key",this.apiKey),e.cookies(this.cookies),e.ignoreContentType(!0);const t=e.execute().body().replace(/\u200b/g,"");this.rooms=JSON.parse(t)}.bind(this)(),function(){let t,o;for(let i of this.rooms.chats)if(i.title===e){t=i.id,o=this.rooms.securityKey;break}if(void 0===t)throw new ReferenceError("invalid room name "+e);const i=org.jsoup.Jsoup.connect("https://sharer.kakao.com/api/talk/message/link");i.header("User-Agent",this.static.ua),i.header("Referer","https://sharer.kakao.com/talk/friends/picker/link"),i.header("Csrf-Token",this.csrf),i.header("App-Key",this.apiKey),i.header("Content-Type","application/json;charset=UTF-8"),i.cookies({KSHARER:this.cookies.KSHARER,TIARA:this.cookies.TIARA,using:this.cookies.using,_kadu:this.cookies._kadu,_kadub:this.cookies._kadub,_kawlt:this.cookies._kawlt,_kawltea:this.cookies._kawltea,_karmt:this.cookies._karmt,_karmtea:this.cookies._karmtea}),i.requestBody(JSON.stringify({receiverChatRoomMemberCount:[1],receiverIds:[t],receiverType:"chat",securityKey:o,validatedTalkLink:this.parsedTemplate})),i.ignoreContentType(!0),i.ignoreHttpErrors(!0),i.method(org.jsoup.Connection.Method.POST);i.execute()}.bind(this)()},e.prototype.sendText=function(e,t,o){this.send(e,{link_ver:"4.0",template_id:46424,template_args:{Text:t,dec:o}},"custom")},e.prototype.sendImage=function(e,t,o,i){this.send(e,{link_ver:"4.0",template_id:46448,template_args:{img:t,Text:o,dec:i}},"custom")},e};
